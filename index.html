<!DOCTYPE html>
<html lang="es">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  Â  <title>PetStories - Crea Cuentos MÃ¡gicos de tu Mascota</title>
Â  Â  <script src="https://cdn.tailwindcss.com"></script>
Â  Â  <link
Â  Â  Â  Â  href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Baloo+2:wght@700;800&display=swap"
Â  Â  Â  Â  rel="stylesheet">
Â  Â  Â  Â  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
Â  Â  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
Â  Â  <style>
Â  Â  Â  Â  body {
Â  Â  Â  Â  Â  Â  font-family: 'Inter', sans-serif;
Â  Â  Â  Â  Â  Â  scroll-behavior: smooth;
Â  Â  Â  Â  }
Â  Â  Â  Â  .font-brand {
Â  Â  Â  Â  Â  Â  font-family: 'Baloo 2', cursive;
Â  Â  Â  Â  }
Â  Â  Â  Â  .hero-bg {
Â  Â  Â  Â  Â  Â  background-image: linear-gradient(to top, rgba(255, 255, 255, 1) 0%, rgba(255, 255, 255, 0) 50%), url('https://images.unsplash.com/photo-1543466835-00a7907e9de1?q=80&w=2874&auto=format&fit=crop');
Â  Â  Â  Â  Â  Â  background-size: cover;
Â  Â  Â  Â  Â  Â  background-position: center 75%;
Â  Â  Â  Â  }
Â  Â  Â  Â  .loader {
Â  Â  Â  Â  Â  Â  border: 4px solid #f3f3f3;
Â  Â  Â  Â  Â  Â  border-top: 4px solid #3498db;
Â  Â  Â  Â  Â  Â  border-radius: 50%;
Â  Â  Â  Â  Â  Â  width: 40px;
Â  Â  Â  Â  Â  Â  height: 40px;
Â  Â  Â  Â  Â  Â  animation: spin 1s linear infinite;
Â  Â  Â  Â  }
Â  Â  Â  Â  .loader-small {
Â  Â  Â  Â  Â  Â  border: 3px solid rgba(255, 255, 255, 0.3);
Â  Â  Â  Â  Â  Â  border-top: 3px solid #fff;
Â  Â  Â  Â  Â  Â  border-radius: 50%;
Â  Â  Â  Â  Â  Â  width: 20px;
Â  Â  Â  Â  Â  Â  height: 20px;
Â  Â  Â  Â  Â  Â  animation: spin 1s linear infinite;
Â  Â  Â  Â  Â  Â  display: inline-block;
Â  Â  Â  Â  Â  Â  vertical-align: middle;
Â  Â  Â  Â  Â  Â  margin-right: 8px;
Â  Â  Â  Â  }
Â  Â  Â  Â  @keyframes spin {
Â  Â  Â  Â  Â  Â  0% {
Â  Â  Â  Â  Â  Â  Â  Â  transform: rotate(0deg);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  100% {
Â  Â  Â  Â  Â  Â  Â  Â  transform: rotate(360deg);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  #flipbook-modal {
Â  Â  Â  Â  Â  Â  background-color: rgba(0, 0, 0, 0.8);
Â  Â  Â  Â  Â  Â  backdrop-filter: blur(5px);
Â  Â  Â  Â  }
Â  Â  Â  Â  .flipbook {
Â  Â  Â  Â  Â  Â  width: 90vw;
Â  Â  Â  Â  Â  Â  height: 60vw;
Â  Â  Â  Â  Â  Â  max-width: 1200px;
Â  Â  Â  Â  Â  Â  max-height: 800px;
Â  Â  Â  Â  Â  Â  perspective: 2500px;
Â  Â  Â  Â  }
Â  Â  Â  Â  .flipbook .fb-page {
Â  Â  Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  Â  Â  width: 50%;
Â  Â  Â  Â  Â  Â  height: 100%;
Â  Â  Â  Â  Â  Â  top: 0;
Â  Â  Â  Â  Â  Â  right: 0;
Â  Â  Â  Â  Â  Â  transform-origin: left;
Â  Â  Â  Â  Â  Â  transition: transform 1s ease-in-out;
Â  Â  Â  Â  Â  Â  transform-style: preserve-3d;
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  }
Â  Â  Â  Â  .flipbook .fb-page .fb-front,
Â  Â  Â  Â  .flipbook .fb-page .fb-back {
Â  Â  Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  height: 100%;
Â  Â  Â  Â  Â  Â  backface-visibility: hidden;
Â  Â  Â  Â  Â  Â  background-color: white;
Â  Â  Â  Â  }
Â  Â  Â  Â  .flipbook .fb-page .fb-back {
Â  Â  Â  Â  Â  Â  transform: rotateY(180deg);
Â  Â  Â  Â  }
Â  Â  Â  Â  .flipbook .fb-page.flipped {
Â  Â  Â  Â  Â  Â  transform: rotateY(-180deg);
Â  Â  Â  Â  }
Â  Â  Â  Â  .page {
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  height: 100%;
Â  Â  Â  Â  Â  Â  backface-visibility: hidden;
Â  Â  Â  Â  Â  Â  -webkit-backface-visibility: hidden;
Â  Â  Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  Â  Â  top: 0;
Â  Â  Â  Â  Â  Â  left: 0;
Â  Â  Â  Â  Â  Â  display: none;
Â  Â  Â  Â  }
Â  Â  Â  Â  .page.active {
Â  Â  Â  Â  Â  Â  display: grid;
Â  Â  Â  Â  }
Â  Â  Â  Â  #toast-notification {
Â  Â  Â  Â  Â  Â  position: fixed;
Â  Â  Â  Â  Â  Â  bottom: 20px;
Â  Â  Â  Â  Â  Â  left: 50%;
Â  Â  Â  Â  Â  Â  transform: translateX(-50%);
Â  Â  Â  Â  Â  Â  background-color: #2d3748;
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  Â  Â  padding: 12px 24px;
Â  Â  Â  Â  Â  Â  border-radius: 9999px;
Â  Â  Â  Â  Â  Â  z-index: 100;
Â  Â  Â  Â  Â  Â  opacity: 0;
Â  Â  Â  Â  Â  Â  visibility: hidden;
Â  Â  Â  Â  Â  Â  transition: opacity 0.3s, visibility 0.3s, transform 0.3s;
Â  Â  Â  Â  }
Â  Â  Â  Â  #toast-notification.show {
Â  Â  Â  Â  Â  Â  opacity: 1;
Â  Â  Â  Â  Â  Â  visibility: visible;
Â  Â  Â  Â  Â  Â  transform: translate(-50%, -10px);
Â  Â  Â  Â  }
Â  Â  </style>
</head>
<body class="bg-gray-50 text-gray-800">
Â  Â  <nav class="bg-white/80 backdrop-blur-md sticky top-0 z-50 shadow-sm">
Â  Â  Â  Â  <div class="container mx-auto px-6 py-3 flex justify-between items-center">
Â  Â  Â  Â  Â  Â  <div class="font-brand text-2xl font-bold text-pink-500"><a href="#">ğŸ¾ PetStories</a></div>
Â  Â  Â  Â  Â  Â  <div class="hidden md:flex space-x-8 items-center">
Â  Â  Â  Â  Â  Â  Â  Â  <a href="#" class="text-gray-600 hover:text-pink-500">Inicio</a>
Â  Â  Â  Â  Â  Â  Â  Â  <a href="#como-funciona" class="text-gray-600 hover:text-pink-500">Â¿CÃ³mo funciona?</a>
Â  Â  Â  Â  Â  Â  Â  Â  <a href="#crear-cuento" class="text-gray-600 hover:text-pink-500">Crear Cuento</a>
Â  Â  Â  Â  Â  Â  Â  Â  <a href="#mis-cuentos" class="text-gray-600 hover:text-pink-500">Mis Cuentos</a>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div id="auth-container" class="relative">
Â  Â  Â  Â  Â  Â  Â  Â  <button id="auth-button" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-full hover:bg-blue-600 transition-colors">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Iniciar SesiÃ³n
Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="user-info" class="hidden items-center gap-x-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span id="user-greeting" class="font-semibold text-gray-700"></span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="logout-btn" class="bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-full hover:bg-gray-300 transition-colors">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Cerrar SesiÃ³n
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  </nav>
Â  Â  <header class="hero-bg">
Â  Â  Â  Â  <div class="container mx-auto px-6 py-24 md:py-32 text-center">
Â  Â  Â  Â  Â  Â  <h1 class="font-brand text-5xl md:text-7xl font-extrabold text-gray-800"><span
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  id="greeting">Â¡Hola!</span><br class="hidden md:block" />Crea Cuentos MÃ¡gicos de tu <span
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  class="text-pink-500">Mascota</span></h1>
Â  Â  Â  Â  Â  Â  <p class="mt-4 max-w-2xl mx-auto text-lg text-gray-600">Transforma a tu peludo amigo en el hÃ©roe de
Â  Â  Â  Â  Â  Â  Â  Â  aventuras increÃ­bles. Nuestra IA crea historias de 8 pÃ¡ginas ilustradas que harÃ¡n sonreÃ­r a toda la
Â  Â  Â  Â  Â  Â  Â  Â  familia.</p>
Â  Â  Â  Â  Â  Â  <div class="mt-8 flex justify-center space-x-4">
Â  Â  Â  Â  Â  Â  Â  Â  <a href="#crear-cuento"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  class="bg-pink-500 text-white font-bold py-3 px-8 rounded-full hover:bg-pink-600 transition-transform transform hover:scale-105 shadow-lg">âœ¨
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Crear Mi Cuento</a>
Â  Â  Â  Â  Â  Â  Â  Â  <a href="#ejemplos"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  class="bg-white text-gray-700 font-bold py-3 px-8 rounded-full hover:bg-gray-100 transition-transform transform hover:scale-105 shadow-lg border">ğŸ“–
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Ver Ejemplos</a>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  </header>
Â  Â  <div class="container mx-auto px-6 py-16">
Â  Â  Â  Â  <section id="como-funciona" class="text-center mb-24">
Â  Â  Â  Â  Â  Â  <h2 class="font-brand text-4xl font-bold text-gray-800">Â¿CÃ³mo Funciona?</h2>
Â  Â  Â  Â  Â  Â  <p class="mt-2 text-gray-500">Crear tu cuento es tan fÃ¡cil como 1, 2, 3.</p>
Â  Â  Â  Â  Â  Â  <div class="mt-12 grid md:grid-cols-3 gap-8">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="bg-white p-8 rounded-2xl shadow-lg flex flex-col">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-pink-500 text-5xl">1.</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="font-brand text-2xl font-bold mt-4">Describe la Aventura</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="mt-2 text-gray-500">Sube una foto de tu mascota o descrÃ­bela. Luego, elige un lugar, una
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  trama y un estilo visual para su historia.</p>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="bg-white p-8 rounded-2xl shadow-lg flex flex-col">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-pink-500 text-5xl">2.</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="font-brand text-2xl font-bold mt-4">Magia de la IA</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="mt-2 text-gray-500">Nuestra Inteligencia Artificial escribirÃ¡ un cuento de 8 pÃ¡ginas y
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  crearÃ¡ ilustraciones mÃ¡gicas para cada una.</p>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="bg-white p-8 rounded-2xl shadow-lg flex flex-col">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-pink-500 text-5xl">3.</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="font-brand text-2xl font-bold mt-4">Lee y Descarga</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="mt-2 text-gray-500">Disfruta de tu cuento personalizado en formato libro digital, y
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  descÃ¡rgalo como un PDF para guardarlo siempre.</p>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </section>
Â  Â  Â  Â  <section id="crear-cuento" class="bg-white p-8 md:p-12 rounded-3xl shadow-2xl">
Â  Â  Â  Â  Â  Â  <header class="text-center mb-12">
Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="font-brand text-5xl font-extrabold text-gray-800">Generador de Cuentos</h2>
Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-gray-500 mt-2">Â¡AquÃ­ comienza la aventura de tu mascota!</p>
Â  Â  Â  Â  Â  Â  </header>
Â  Â  Â  Â  Â  Â  <main class="grid grid-cols-1 lg:grid-cols-2 gap-8 lg:gap-12">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="bg-gray-50 p-6 rounded-xl border border-gray-200">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <form id="story-form" class="space-y-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div><label for="pet_image" class="block text-sm font-medium text-gray-600 mb-1">Sube una foto
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  de tu mascota (opcional):</label><input type="file" id="pet_image" name="pet_image"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  accept="image/*"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-pink-50 file:text-pink-700 hover:file:bg-pink-100">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="mt-2 text-center"><img id="image_preview"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  class="hidden max-h-40 mx-auto rounded-lg shadow-sm"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alt="Vista previa de la mascota"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="character_desc_group"><label for="character_desc"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  class="block text-sm font-medium text-gray-600 mb-1">O describe a tu
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  personaje:</label><textarea id="character_desc" name="character_desc" rows="3"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-pink-500 focus:border-pink-500"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  placeholder="Ej: Un conejo blanco y bajito con orejas largas..." required></textarea>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div><label for="character" class="block text-sm font-medium text-gray-600 mb-1">Nombre de tu
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mascota / personaje:</label><input type="text" id="character" name="character"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-pink-500 focus:border-pink-500"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  placeholder="Ej: El conejo Tito" required></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div><label for="setting" class="block text-sm font-medium text-gray-600 mb-1">Lugar o
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mundo:</label><input type="text" id="setting" name="setting"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-pink-500 focus:border-pink-500"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  placeholder="Ej: Un bosque de caramelos" required></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex justify-between items-center mb-1"><label for="plot"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  class="block text-sm font-medium text-gray-600">Trama o problema:</label><button
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  type="button" id="suggest-plot-btn"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  class="text-sm bg-purple-100 text-purple-700 hover:bg-purple-200 font-semibold py-1 px-3 rounded-full">âœ¨
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Sugerir Trama</button></div><textarea id="plot" name="plot" rows="3"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-pink-500 focus:border-pink-500"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  placeholder="Ej: Ha perdido su zanahoria cohete..." required></textarea>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="plot-suggestions" class="mt-2 space-y-2"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div><label for="style" class="block text-sm font-medium text-gray-600 mb-1">Estilo de
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ilustraciÃ³n:</label><select id="style" name="style"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-pink-500 focus:border-pink-500">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="estilo acuarela digital">Acuarela digital</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="estilo libro de cuentos clÃ¡sico">Libro de cuentos clÃ¡sico</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="estilo de dibujos animados alegres">Dibujos animados alegres</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="arte de fantasÃ­a encantado">FantasÃ­a encantada</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </select></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div><label for="visual_modifier" class="block text-sm font-medium text-gray-600 mb-1">Dinamismo
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Visual:</label><select id="visual_modifier" name="visual_modifier"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-pink-500 focus:border-pink-500">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="variado">Variado (Recomendado)</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="planos cercanos">Enfocar en Personajes</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="planos generales">Mostrar el Entorno</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </select></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div><label for="reading_level" class="block text-sm font-medium text-gray-600 mb-1">Nivel de
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Lectura:</label><select id="reading_level" name="reading_level"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-pink-500 focus:border-pink-500">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="para niÃ±os de 3 a 6 aÃ±os">Infantil (3-6 aÃ±os)</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="para niÃ±os de 7 a 12 aÃ±os">Juvenil (7-12 aÃ±os)</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="para adolescentes de 13+ aÃ±os">Adolescente (13+ aÃ±os)</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </select></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="submit" id="generate-btn"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  class="w-full bg-pink-500 text-white font-bold py-3 px-4 rounded-md hover:bg-pink-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-pink-500 transition-transform transform hover:scale-105 flex items-center justify-center shadow-lg">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span id="btn-text">Generar Mi Cuento</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <svg id="btn-loader"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  class="animate-spin h-5 w-5 text-white hidden"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  stroke-width="4"></circle>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <path class="opacity-75" fill="currentColor"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </path>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </svg>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </form>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="ebook-container"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  class="bg-gray-50 p-6 rounded-xl border border-gray-200 flex flex-col items-center justify-center min-h-[500px]">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="ebook-placeholder" class="text-center text-gray-400"><svg
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  xmlns="http://www.w3.org/2000/svg" class="mx-auto h-24 w-24 text-gray-300" fill="none"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  viewBox="0 0 24 24" stroke="currentColor">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  d="M12 6.253v11.494m-9-5.494h18M6.613 4.512l10.774 14.976M4.512 17.387l14.976-10.774M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </svg>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="mt-4 font-brand text-2xl">Tu cuento aparecerÃ¡ aquÃ­...</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="ebook-content" class="w-full h-full relative"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="loading-view" class="hidden flex-col items-center justify-center text-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="loader"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p id="loading-message" class="mt-4 text-gray-600 font-semibold">Generando tu historia...</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </main>
Â  Â  Â  Â  </section>
Â  Â  Â  Â  <section id="ejemplos" class="mt-24 text-center">
Â  Â  Â  Â  Â  Â  <h2 class="font-brand text-4xl font-bold text-gray-800">Cuentos de Muestra</h2>
Â  Â  Â  Â  Â  Â  <p class="mt-2 text-gray-500">Haz clic en un ejemplo para generar una vista previa.</p>
Â  Â  Â  Â  Â  Â  <div class="mt-12 grid md:grid-cols-3 gap-8">
Â  Â  Â  Â  Â  Â  Â  Â  <a href="#" id="example-lara"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  class="bg-white rounded-2xl shadow-lg overflow-hidden cursor-pointer transform hover:scale-105 transition-transform flex flex-col"><img
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  src="https://placehold.co/600x400/fecaca/991b1b?text=Lara+la+Exploradora"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alt="Ejemplo de cuento 1" class="w-full h-48 object-cover">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="p-6 flex-grow flex flex-col">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="font-brand text-2xl font-bold">Lara la Exploradora</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="mt-2 text-gray-500 text-sm">Lara descubre un mapa misterioso en el jardÃ­n y se embarca
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  en una aventura para encontrar el tesoro perdido de los ladridos.</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </a>
Â  Â  Â  Â  Â  Â  Â  Â  <a href="#" id="example-max"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  class="bg-white rounded-2xl shadow-lg overflow-hidden cursor-pointer transform hover:scale-105 transition-transform flex flex-col"><img
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  src="https://placehold.co/600x400/d1fae5/065f46?text=Max+en+el+Espacio"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alt="Ejemplo de cuento 2" class="w-full h-48 object-cover">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="p-6 flex-grow flex flex-col">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="font-brand text-2xl font-bold">Max en el Espacio</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="mt-2 text-gray-500 text-sm">El gato Max construye un cohete de cartÃ³n y viaja a la
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  luna, donde se hace amigo de los ratones lunares que aman el queso.</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </a>
Â  Â  Â  Â  Â  Â  Â  Â  <a href="#" id="example-rocky"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  class="bg-white rounded-2xl shadow-lg overflow-hidden cursor-pointer transform hover:scale-105 transition-transform flex flex-col"><img
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  src="https://placehold.co/600x400/e0e7ff/3730a3?text=Rocky+el+Detective"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alt="Ejemplo de cuento 3" class="w-full h-48 object-cover">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="p-6 flex-grow flex flex-col">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="font-brand text-2xl font-bold">Rocky el Detective</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="mt-2 text-gray-500 text-sm">El misterio de la galleta desaparecida. El astuto hamster
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Rocky sigue las migas para resolver su caso mÃ¡s delicioso.</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </a>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </section>
Â  Â  Â  Â  <section id="mis-cuentos" class="mt-24 text-center hidden">
Â  Â  Â  Â  Â  Â  <h2 class="font-brand text-4xl font-bold text-gray-800">Mi Biblioteca de Cuentos</h2>
Â  Â  Â  Â  Â  Â  <p class="mt-2 text-gray-500">AquÃ­ estÃ¡n todas las aventuras que has creado.</p>
Â  Â  Â  Â  Â  Â  <div id="saved-stories-grid" class="mt-12 grid md:grid-cols-2 lg:grid-cols-3 gap-8">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </section>
Â  Â  </div>
Â  Â  <footer class="bg-white mt-16 py-8">
Â  Â  Â  Â  <div class="container mx-auto text-center text-gray-500">
Â  Â  Â  Â  Â  Â  <p>&copy; 2024 PetStories. Creado con â¤ï¸ y un poco de magia IA.</p>
Â  Â  Â  Â  </div>
Â  Â  </footer>
Â  Â  Â  Â  <div id="auth-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
Â  Â  Â  Â  <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-sm w-full relative">
Â  Â  Â  Â  Â  Â  <button id="close-auth-modal" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
Â  Â  Â  Â  Â  Â  <h2 id="auth-title" class="font-brand text-3xl font-bold text-gray-800 mb-6 text-center">Ãšnete a la Aventura</h2>
Â  Â  Â  Â  Â  Â  <form id="email-form" class="space-y-4">
Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="name-input" placeholder="Tu nombre" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-pink-500 focus:border-pink-500">
Â  Â  Â  Â  Â  Â  Â  Â  <input type="email" id="email-input" placeholder="Correo electrÃ³nico" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-pink-500 focus:border-pink-500">
Â  Â  Â  Â  Â  Â  Â  Â  <input type="password" id="password-input" placeholder="ContraseÃ±a" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-pink-500 focus:border-pink-500">
Â  Â  Â  Â  Â  Â  Â  Â  <p id="auth-error-message" class="text-red-500 text-sm text-center h-4"></p>
Â  Â  Â  Â  Â  Â  Â  Â  <button type="submit" id="auth-submit-btn" class="w-full bg-pink-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-pink-600 transition-colors">Registrarse</button>
Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-center text-sm text-gray-500">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span id="auth-prompt-text">Â¿Ya tienes una cuenta?</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <a href="#" id="auth-toggle-link" class="font-semibold text-pink-500 hover:underline">Inicia SesiÃ³n</a>
Â  Â  Â  Â  Â  Â  Â  Â  </p>
Â  Â  Â  Â  Â  Â  </form>
Â  Â  Â  Â  </div>
Â  Â  </div>
Â  Â  <div id="flipbook-modal" class="fixed inset-0 w-full h-full z-[60] hidden items-center justify-center p-4">
Â  Â  Â  Â  <div id="flipbook-container" class="relative flipbook"></div><button id="close-flipbook"
Â  Â  Â  Â  Â  Â  class="absolute top-4 right-4 text-white text-5xl font-bold">&times;</button>
Â  Â  </div>
Â  Â  <div id="print-order-modal"
Â  Â  Â  Â  class="fixed inset-0 w-full h-full z-[60] hidden items-center justify-center p-4 bg-black/50 backdrop-blur-sm">
Â  Â  Â  Â  <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-lg w-full">
Â  Â  Â  Â  Â  Â  <h2 class="font-brand text-3xl font-bold text-gray-800 mb-4">Â¡Pide tu Cuento en Tapa Dura!</h2>
Â  Â  Â  Â  Â  Â  <p class="text-gray-600 mb-6">Recibe una copia fÃ­sica de alta calidad de la aventura de tu mascota. Â¡Un
Â  Â  Â  Â  Â  Â  Â  Â  recuerdo para siempre!</p>
Â  Â  Â  Â  Â  Â  <form id="print-form">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="space-y-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div><label for="print-name" class="block text-sm font-medium text-gray-600">Nombre
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Completo</label><input type="text" id="print-name"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-md" required></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div><label for="print-address" class="block text-sm font-medium text-gray-600">DirecciÃ³n de
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  EnvÃ­o</label><textarea id="print-address" rows="3"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-md" required></textarea></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-center font-bold text-xl text-pink-500 py-2">Total: 24,99 â‚¬</div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="mt-8 flex justify-end space-x-4"><button type="button" id="cancel-print-btn"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  class="bg-gray-200 text-gray-700 font-bold py-2 px-6 rounded-full hover:bg-gray-300">Cancelar</button><button
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  type="submit"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  class="bg-green-500 text-white font-bold py-2 px-6 rounded-full hover:bg-green-600">Realizar
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Pedido</button></div>
Â  Â  Â  Â  Â  Â  </form>
Â  Â  Â  Â  </div>
Â  Â  </div>
Â  Â  <div id="toast-notification"></div>
Â  Â  <script type="module">
Â  Â  Â  Â  // --- INICIO DEL CÃ“DIGO DE LA APLICACIÃ“N ---
Â  Â  Â  Â  document.addEventListener('DOMContentLoaded', () => {
Â  Â  Â  Â  Â  Â  // --- App Config (Provided by User) ---
Â  Â  Â  Â  Â  Â  // INSTRUCCIONES: Reemplaza la cadena vacÃ­a con tu clave de API de Google AI Studio.
Â  Â  Â  Â  Â  Â  // Puedes obtenerla en https://aistudio.google.com/app/apikey
Â  Â  Â  Â  Â  Â  const googleAiApiKey = "AIzaSyBLsNvpfVDDxRSfDMo3LHOKkxYA2b-KFgA";
Â  Â  Â  Â  Â  Â  // --- DOM Elements ---
Â  Â  Â  Â  Â  Â  const storyForm = document.getElementById('story-form');
Â  Â  Â  Â  Â  Â  const generateBtn = document.getElementById('generate-btn');
Â  Â  Â  Â  Â  Â  const ebookContainer = document.getElementById('ebook-container');
Â  Â  Â  Â  Â  Â  const ebookContent = document.getElementById('ebook-content');
Â  Â  Â  Â  Â  Â  const loadingView = document.getElementById('loading-view');
Â  Â  Â  Â  Â  Â  const loadingMessage = document.getElementById('loading-message');
Â  Â  Â  Â  Â  Â  const ebookPlaceholder = document.getElementById('ebook-placeholder');
Â  Â  Â  Â  Â  Â  const petImageInput = document.getElementById('pet_image');
Â  Â  Â  Â  Â  Â  const imagePreview = document.getElementById('image_preview');
Â  Â  Â  Â  Â  Â  const characterDescInput = document.getElementById('character_desc');
Â  Â  Â  Â  Â  Â  const suggestPlotBtn = document.getElementById('suggest-plot-btn');
Â  Â  Â  Â  Â  Â  const plotSuggestionsContainer = document.getElementById('plot-suggestions');
Â  Â  Â  Â  Â  Â  const plotInput = document.getElementById('plot');
Â  Â  Â  Â  Â  Â  const flipbookModal = document.getElementById('flipbook-modal');
Â  Â  Â  Â  Â  Â  const flipbookContainer = document.getElementById('flipbook-container');
Â  Â  Â  Â  Â  Â  const closeFlipbookBtn = document.getElementById('close-flipbook');
Â  Â  Â  Â  Â  Â  const greeting = document.getElementById('greeting');
Â  Â  Â  Â  Â  Â  const printModal = document.getElementById('print-order-modal');
Â  Â  Â  Â  Â  Â  const cancelPrintBtn = document.getElementById('cancel-print-btn');
Â  Â  Â  Â  Â  Â  const printForm = document.getElementById('print-form');
Â  Â  Â  Â  Â  Â  const toast = document.getElementById('toast-notification');
Â  Â  Â  Â  Â  Â  const savedStoriesSection = document.getElementById('mis-cuentos');
Â  Â  Â  Â  Â  Â  const savedStoriesGrid = document.getElementById('saved-stories-grid');
Â  Â  Â  Â  Â  Â  // Auth UI Elements
Â  Â  Â  Â  Â  Â  const authModal = document.getElementById('auth-modal');
Â  Â  Â  Â  Â  Â  const authButton = document.getElementById('auth-button');
Â  Â  Â  Â  Â  Â  const closeAuthModalBtn = document.getElementById('close-auth-modal');
Â  Â  Â  Â  Â  Â  const emailForm = document.getElementById('email-form');
Â  Â  Â  Â  Â  Â  const nameInput = document.getElementById('name-input');
Â  Â  Â  Â  Â  Â  const emailInput = document.getElementById('email-input');
Â  Â  Â  Â  Â  Â  const passwordInput = document.getElementById('password-input');
Â  Â  Â  Â  Â  Â  const authErrorMessage = document.getElementById('auth-error-message');
Â  Â  Â  Â  Â  Â  const authTitle = document.getElementById('auth-title');
Â  Â  Â  Â  Â  Â  const authSubmitBtn = document.getElementById('auth-submit-btn');
Â  Â  Â  Â  Â  Â  const authPromptText = document.getElementById('auth-prompt-text');
Â  Â  Â  Â  Â  Â  const authToggleLink = document.getElementById('auth-toggle-link');
Â  Â  Â  Â  Â  Â  const userInfo = document.getElementById('user-info');
Â  Â  Â  Â  Â  Â  const userGreeting = document.getElementById('user-greeting');
Â  Â  Â  Â  Â  Â  const logoutBtn = document.getElementById('logout-btn');
Â  Â  Â  Â  Â  Â  // --- App State ---
Â  Â  Â  Â  Â  Â  let currentPage = 0;
Â  Â  Â  Â  Â  Â  let totalPages = 0;
Â  Â  Â  Â  Â  Â  let storyPagesData = [];
Â  Â  Â  Â  Â  Â  let currentStoryTitle = '';
Â  Â  Â  Â  Â  Â  let coverImageData = '';
Â  Â  Â  Â  Â  Â  let currentUser = null; // Simulated user session
Â  Â  Â  Â  Â  Â  let isRegisterMode = true; // Start in register mode
Â  Â  Â  Â  Â  Â  const exampleStories = {
Â  Â  Â  Â  Â  Â  Â  Â  'example-lara': { character: 'Lara', character_desc: 'Una perrita golden retriever, joven y aventurera, con un pelaje dorado brillante y una bandana roja en el cuello.', setting: 'Un jardÃ­n trasero que esconde secretos antiguos y caminos inexplorados.', plot: 'Lara descubre un mapa misterioso enterrado bajo su rosal favorito. El mapa la guÃ­a en una emocionante bÃºsqueda del legendario Tesoro Perdido de los Ladridos, enfrentÃ¡ndose a ardillas astutas y topos gruÃ±ones en el camino.', style: 'estilo acuarela digital', reading_level: 'para niÃ±os de 7 a 12 aÃ±os', visual_modifier: 'variado' },
Â  Â  Â  Â  Â  Â  Â  Â  'example-max': { character: 'Max', character_desc: 'Un gato negro y sigiloso con brillantes ojos verdes y un collar con un pequeÃ±o cascabel que nunca suena.', setting: 'La luna, hecha de queso suizo, con crÃ¡teres llenos de leche y estrellas que son bolas de estambre.', plot: 'Aburrido de los juguetes terrestres, el gato Max construye un cohete con una caja de cartÃ³n y viaja a la luna. AllÃ­, se hace amigo de los amistosos ratones lunares, que le enseÃ±an a rebotar en la baja gravedad y a surfear en los rÃ­os de leche.', style: 'estilo de dibujos animados alegres', reading_level: 'para niÃ±os de 3 a 6 aÃ±os', visual_modifier: 'variado' },
Â  Â  Â  Â  Â  Â  Â  Â  'example-rocky': { character: 'Rocky', character_desc: 'Un pequeÃ±o y regordete hamster de color marrÃ³n y blanco, con grandes mofletes y un sombrero de detective de papel.', setting: 'Una compleja ciudad de tubos de plÃ¡stico y tÃºneles dentro de una jaula, con una rueda de ejercicio como el centro de la ciudad.', plot: 'Â¡Ha desaparecido la galleta mÃ¡s grande y deliciosa de la jaula! El astuto detective Rocky, sigue un rastro de migas y pistas para interrogar a los otros habitantes de la jaula y resolver el caso mÃ¡s sabroso de su carrera.', style: 'estilo libro de cuentos clÃ¡sico', reading_level: 'para niÃ±os de 7 a 12 aÃ±os', visual_modifier: 'variado' }
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  // --- Initialization ---
Â  Â  Â  Â  Â  Â  initApp();
Â  Â  Â  Â  Â  Â  function initApp() {
Â  Â  Â  Â  Â  Â  Â  Â  Â if (!googleAiApiKey || googleAiApiKey.includes("REEMPLAZA")) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showConfigurationError("La clave de API de Google AI no estÃ¡ configurada. Por favor, sigue las instrucciones en el cÃ³digo para aÃ±adir tu clave de API de Google AI Studio.");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  setupEventListeners();
Â  Â  Â  Â  Â  Â  Â  Â  checkSession();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  function showConfigurationError(message) {
Â  Â  Â  Â  Â  Â  Â  Â  Â const body = document.querySelector('body');
Â  Â  Â  Â  Â  Â  Â  Â  Â body.innerHTML = `<div class="h-screen w-screen flex items-center justify-center p-4 bg-gray-100">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-center text-red-700 bg-red-100 p-8 rounded-lg shadow-2xl max-w-2xl">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="font-brand font-bold text-3xl text-red-800">Error de ConfiguraciÃ³n CrÃ­tico</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="mt-4 text-gray-700">${message}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>`;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  function setupEventListeners() {
Â  Â  Â  Â  Â  Â  Â  Â  document.querySelectorAll('[id^="example-"]').forEach(card => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  card.addEventListener('click', (e) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const exampleData = exampleStories[card.id];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (exampleData) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('crear-cuento').scrollIntoView({ behavior: 'smooth' });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  handleStoryGeneration(null, exampleData, false);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  storyForm.addEventListener('submit', (e) => handleStoryGeneration(e, null, true));
Â  Â  Â  Â  Â  Â  Â  Â  suggestPlotBtn.addEventListener('click', handlePlotSuggestion);
Â  Â  Â  Â  Â  Â  Â  Â  petImageInput.addEventListener('change', handleImagePreview);
Â  Â  Â  Â  Â  Â  Â  Â  closeFlipbookBtn.addEventListener('click', () => flipbookModal.style.display = 'none');
Â  Â  Â  Â  Â  Â  Â  Â  cancelPrintBtn.addEventListener('click', () => printModal.style.display = 'none');
Â  Â  Â  Â  Â  Â  Â  Â  printForm.addEventListener('submit', (e) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  printModal.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showToast("Â¡Pedido recibido! (Esto es una simulaciÃ³n).");
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  authButton.addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  toggleAuthMode(null, true); // Open in register mode by default
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  authModal.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  closeAuthModalBtn.addEventListener('click', () => authModal.classList.add('hidden'));
Â  Â  Â  Â  Â  Â  Â  Â  authToggleLink.addEventListener('click', toggleAuthMode);
Â  Â  Â  Â  Â  Â  Â  Â  emailForm.addEventListener('submit', handleAuthFormSubmit);
Â  Â  Â  Â  Â  Â  Â  Â  logoutBtn.addEventListener('click', handleLogout);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  // --- Auth Functions ---
Â  Â  Â  Â  Â  Â  function checkSession() {
Â  Â  Â  Â  Â  Â  Â  Â  const userSession = sessionStorage.getItem('petstories_user');
Â  Â  Â  Â  Â  Â  Â  Â  if (userSession) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updateUserUI(JSON.parse(userSession));
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updateUserUI(null);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  function updateUserUI(user) {
Â  Â  Â  Â  Â  Â  Â  Â  currentUser = user;
Â  Â  Â  Â  Â  Â  Â  Â  if (user) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  authButton.classList.add('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  userInfo.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  userInfo.classList.add('flex');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  userGreeting.textContent = `Â¡Hola, ${user.name}!`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  greeting.textContent = `Â¡Hola, ${user.name}!`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  authModal.classList.add('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  loadUserStories();
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  authButton.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  userInfo.classList.add('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  userInfo.classList.remove('flex');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  greeting.textContent = "Â¡Hola!";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  clearUserStories();
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  function toggleAuthMode(e, forceRegister = false) {
Â  Â  Â  Â  Â  Â  Â  Â  if(e) e.preventDefault();
Â  Â  Â  Â  Â  Â  Â  Â  isRegisterMode = forceRegister ? true : !isRegisterMode;
Â  Â  Â  Â  Â  Â  Â  Â  authErrorMessage.textContent = '';
Â  Â  Â  Â  Â  Â  Â  Â  if (isRegisterMode) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  authTitle.textContent = 'Ãšnete a la Aventura';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  nameInput.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  nameInput.required = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  authSubmitBtn.textContent = 'Registrarse';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  authPromptText.textContent = 'Â¿Ya tienes una cuenta?';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  authToggleLink.textContent = 'Inicia SesiÃ³n';
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  authTitle.textContent = 'Bienvenido/a de Nuevo';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  nameInput.classList.add('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  nameInput.required = false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  authSubmitBtn.textContent = 'Iniciar SesiÃ³n';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  authPromptText.textContent = 'Â¿No tienes una cuenta?';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  authToggleLink.textContent = 'RegÃ­strate';
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  function handleAuthFormSubmit(e) {
Â  Â  Â  Â  Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  Â  Â  Â  Â  const name = nameInput.value;
Â  Â  Â  Â  Â  Â  Â  Â  const email = emailInput.value.toLowerCase();
Â  Â  Â  Â  Â  Â  Â  Â  const password = passwordInput.value;
Â  Â  Â  Â  Â  Â  Â  Â  let users = JSON.parse(localStorage.getItem('petstories_users')) || {};
Â  Â  Â  Â  Â  Â  Â  Â  if (isRegisterMode) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!name || !email || !password) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  authErrorMessage.textContent = 'Por favor, rellena todos los campos.';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (users[email]) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  authErrorMessage.textContent = 'Este email ya estÃ¡ registrado.';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  users[email] = { name, password }; // Note: Storing password in plain text is not secure for real apps.
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  localStorage.setItem('petstories_users', JSON.stringify(users));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const newUser = { name, email };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sessionStorage.setItem('petstories_user', JSON.stringify(newUser));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updateUserUI(newUser);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showToast(`Â¡Registro completado! Bienvenido/a, ${name}.`);
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â if (!email || !password) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  authErrorMessage.textContent = 'Por favor, introduce email y contraseÃ±a.';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!users[email] || users[email].password !== password) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  authErrorMessage.textContent = 'Email o contraseÃ±a incorrectos.';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const loggedInUser = { name: users[email].name, email };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sessionStorage.setItem('petstories_user', JSON.stringify(loggedInUser));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updateUserUI(loggedInUser);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showToast(`Â¡Bienvenido/a de nuevo, ${users[email].name}!`);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  function handleLogout(e) {
Â  Â  Â  Â  Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  Â  Â  Â  Â  sessionStorage.removeItem('petstories_user');
Â  Â  Â  Â  Â  Â  Â  Â  updateUserUI(null);
Â  Â  Â  Â  Â  Â  Â  Â  showToast('Has cerrado sesiÃ³n.');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  function loadUserStories() {
Â  Â  Â  Â  Â  Â  Â  Â  if (!currentUser) return;
Â  Â  Â  Â  Â  Â  Â  Â  const allStories = JSON.parse(localStorage.getItem('petstories_stories')) || {};
Â  Â  Â  Â  Â  Â  Â  Â  const userStories = allStories[currentUser.email] || [];
Â  Â  Â  Â  Â  Â  Â  Â  if (userStories.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  savedStoriesGrid.innerHTML = '<p class="text-gray-500 col-span-full">AÃºn no has creado ningÃºn cuento. Â¡AnÃ­mate a crear el primero!</p>';
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  savedStoriesGrid.innerHTML = '';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  userStories.forEach((storyData, index) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  createStoryCard(index, storyData);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  savedStoriesSection.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  function createStoryCard(storyId, storyData) {
Â  Â  Â  Â  Â  Â  Â  Â  const card = document.createElement('a');
Â  Â  Â  Â  Â  Â  Â  Â  card.href = '#crear-cuento';
Â  Â  Â  Â  Â  Â  Â  Â  card.className = "bg-white rounded-2xl shadow-lg overflow-hidden cursor-pointer transform hover:scale-105 transition-transform flex flex-col";
Â  Â  Â  Â  Â  Â  Â  Â  card.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <img src="${storyData.coverImage}" alt="Portada de ${storyData.title}" class="w-full h-48 object-cover" onerror="this.src='https://placehold.co/600x400/cccccc/333333?text=ğŸ¾'">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="p-6 flex-grow flex flex-col">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="font-brand text-2xl font-bold">${storyData.title}</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>`;
Â  Â  Â  Â  Â  Â  Â  Â  card.addEventListener('click', (e) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('crear-cuento').scrollIntoView({ behavior: 'smooth' });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  renderEbook(storyData.title, storyData.coverImage, storyData.pages);
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  savedStoriesGrid.appendChild(card);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  function clearUserStories() {
Â  Â  Â  Â  Â  Â  Â  Â  savedStoriesSection.classList.add('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  savedStoriesGrid.innerHTML = '';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  // --- UI Functions ---
Â  Â  Â  Â  Â  Â  function showToast(message) {
Â  Â  Â  Â  Â  Â  Â  Â  toast.textContent = message;
Â  Â  Â  Â  Â  Â  Â  Â  toast.classList.add('show');
Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => { toast.classList.remove('show'); }, 3000);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  function setLoading(isLoading, message = '') {
Â  Â  Â  Â  Â  Â  Â  Â  generateBtn.disabled = isLoading;
Â  Â  Â  Â  Â  Â  Â  Â  generateBtn.querySelector('#btn-text').style.display = isLoading ? 'none' : 'inline';
Â  Â  Â  Â  Â  Â  Â  Â  generateBtn.querySelector('#btn-loader').style.display = isLoading ? 'inline-block' : 'none';
Â  Â  Â  Â  Â  Â  Â  Â  if (isLoading) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ebookPlaceholder.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ebookContent.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ebookContent.innerHTML = '';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  loadingView.style.display = 'flex';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  loadingMessage.textContent = message;
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  loadingView.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (ebookContent.innerHTML !== '') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ebookContent.style.display = 'block';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ebookPlaceholder.style.display = 'block';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  function displayError(message) {
Â  Â  Â  Â  Â  Â  Â  Â  setLoading(false);
Â  Â  Â  Â  Â  Â  Â  Â  ebookPlaceholder.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  ebookContent.innerHTML = `<div class="text-center text-red-500 bg-red-100 p-4 rounded-lg"><h3 class="font-bold">Â¡Oh no! Algo saliÃ³ mal</h3><p class="text-sm mt-1">${message}</p></div>`;
Â  Â  Â  Â  Â  Â  Â  Â  ebookContent.style.display = 'block';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  async function handleApiError(response) {
Â  Â  Â  Â  Â  Â  Â  Â  let errorBody = 'Could not read error body.';
Â  Â  Â  Â  Â  Â  Â  Â  try { errorBody = await response.json(); } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  try { errorBody = await response.text(); } catch (readError) { console.error("Could not read response text.", readError); }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  console.error("API Error Response:", errorBody);
Â  Â  Â  Â  Â  Â  Â  Â  const specificMessage = errorBody?.error?.message || (typeof errorBody === 'string' ? errorBody : JSON.stringify(errorBody));
Â  Â  Â  Â  Â  Â  Â  Â  return specificMessage || response.statusText || "OcurriÃ³ un error en la API.";
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  function handleImagePreview() {
Â  Â  Â  Â  Â  Â  Â  Â  const file = petImageInput.files[0];
Â  Â  Â  Â  Â  Â  Â  Â  if (file) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const reader = new FileReader();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  reader.onload = (e) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  imagePreview.src = e.target.result;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  imagePreview.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  characterDescInput.required = false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  reader.readAsDataURL(file);
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â imagePreview.classList.add('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â characterDescInput.required = true;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  function extractAndParseJson(text) {
Â  Â  Â  Â  Â  Â  Â  Â  const jsonMatch = text.match(/\{[\s\S]*\}/);
Â  Â  Â  Â  Â  Â  Â  Â  if (jsonMatch && jsonMatch[0]) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  try { return JSON.parse(jsonMatch[0]); } catch (e) { console.error("Failed to parse extracted JSON:", e, "Original text:", text); }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  try { return JSON.parse(text); } catch(e) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("Failed to parse the entire text as JSON:", e, "Original text:", text);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  throw new Error("La IA devolviÃ³ una respuesta con formato JSON invÃ¡lido.");
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  // --- Core Application Logic ---
Â  Â  Â  Â  Â  Â  async function handleStoryGeneration(event, predefinedData = null, shouldSave = false) {
Â  Â  Â  Â  Â  Â  Â  Â  if (event) event.preventDefault();
Â  Â  Â  Â  Â  Â  Â  Â  if (!currentUser && shouldSave) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showToast('Por favor, inicia sesiÃ³n para crear y guardar un cuento.');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  authModal.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  setLoading(true, "Iniciando la magia...");
Â  Â  Â  Â  Â  Â  Â  Â  let storyData;
Â  Â  Â  Â  Â  Â  Â  Â  if (predefinedData) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  storyData = predefinedData;
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const formData = new FormData(storyForm);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const petImageFile = formData.get('pet_image');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let petDescription = formData.get('character_desc');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (petImageFile && petImageFile.size > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setLoading(true, "Analizando la foto de tu mascota...");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const imageBase64 = await readFileAsBase64(petImageFile);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const analysisResult = await analyzePetImage(imageBase64);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!analysisResult.isPet) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  displayError("La imagen no parece contener una mascota. Por favor, sube otra foto o descrÃ­bela manualmente.");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setLoading(false);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  petDescription = analysisResult.description;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } catch(error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â displayError(error.message);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â setLoading(false);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â return;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!petDescription) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  displayError("Por favor, sube una foto de tu mascota o proporciona una descripciÃ³n.");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setLoading(false);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  storyData = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  character: formData.get('character'),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  character_desc: petDescription,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setting: formData.get('setting'),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  plot: formData.get('plot'),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  style: formData.get('style'),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  visual_modifier: formData.get('visual_modifier'),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  reading_level: formData.get('reading_level'),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setLoading(true, "Escribiendo tu aventura...");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const story = await generateStoryText(storyData);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!story || !story.parrafos || story.parrafos.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  throw new Error("La IA no generÃ³ pÃ¡rrafos para la historia. IntÃ©ntalo de nuevo.");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentStoryTitle = story.titulo;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setLoading(true, "Creando portada...");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const coverPrompt = `Crea una portada de libro infantil artÃ­stica y llamativa. El tÃ­tulo es "${story.titulo}". El personaje principal es ${storyData.character}, que es ${storyData.character_desc}. Estilo: ${storyData.style}. Sin texto.`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  coverImageData = await generateImage(coverPrompt);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const visualModifiers = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'variado': ['plano general amplio', 'primer plano emocional del personaje', 'toma de acciÃ³n dinÃ¡mica', 'vista desde un Ã¡ngulo bajo', 'vista desde arriba', 'iluminaciÃ³n suave y cÃ¡lida', 'silueta contra el atardecer', 'plano medio del personaje interactuando'],
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'planos cercanos': ['primer plano del personaje', 'plano medio mostrando la expresiÃ³n', 'detalle de las patas del personaje', 'mirada por encima del hombro'],
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'planos generales': ['plano general muy amplio mostrando el paisaje', 'vista panorÃ¡mica', 'el personaje es pequeÃ±o en la escena', 'vista de pÃ¡jaro']
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const selectedModifierSet = visualModifiers[storyData.visual_modifier] || visualModifiers['variado'];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const pages = [];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  for (let i = 0; i < story.parrafos.length; i++) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setLoading(true, `Creando ilustraciones... (${i + 1}/${story.parrafos.length})`);
const front = document.createElement('div');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  front.className = 'fb-front p-4 border rounded-r-lg';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  front.innerHTML = `<div class="w-full h-full flex flex-col gap-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <img src="${storyPagesData[i].imageUrl}" class="w-full h-1/2 object-cover rounded-t-lg">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <p class="p-2 text-xs">${storyPagesData[i].text}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const back = document.createElement('div');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  back.className = 'fb-back p-4 border rounded-l-lg';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (storyPagesData[i + 1]) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  back.innerHTML = `<div class="w-full h-full flex flex-col gap-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <img src="${storyPagesData[i + 1].imageUrl}" class="w-full h-1/2 object-cover rounded-t-lg">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="p-2 text-xs">${storyPagesData[i + 1].text}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  back.innerHTML = `<div class="w-full h-full bg-pink-500 flex items-center justify-center text-white p-8 rounded-l-lg text-center"><h3 class="font-brand text-4xl">Fin</h3></div>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  fbPage.appendChild(front);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  fbPage.appendChild(back);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  flipbookContainer.appendChild(fbPage);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  fbPage.addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  fbPage.classList.toggle('flipped');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  flipbookModal.style.display = 'flex';
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  async function downloadPDF(title) {
Â  Â  Â  Â  Â  Â  Â  Â  const { jsPDF } = window.jspdf;
Â  Â  Â  Â  Â  Â  Â  Â  const doc = new jsPDF({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  orientation: 'landscape',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  unit: 'px',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  format: [800, 600] // Aspect ratio for pages
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  const btn = document.getElementById('download-pdf-btn');
Â  Â  Â  Â  Â  Â  Â  Â  const originalText = btn.textContent;
Â  Â  Â  Â  Â  Â  Â  Â  btn.textContent = 'Generando PDF...';
Â  Â  Â  Â  Â  Â  Â  Â  btn.disabled = true;

Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  for (let i = 0; i < totalPages; i++) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const pageElement = document.getElementById(`page-${i}`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (pageElement) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const canvas = await html2canvas(pageElement, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  scale: 2, // Higher scale for better quality
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  useCORS: true,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  allowTaint: true
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const imgData = canvas.toDataURL('image/png');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (i > 0) doc.addPage();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  doc.addImage(imgData, 'PNG', 0, 0, 800, 600);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  doc.save(`${title.replace(/\s/g, '_')}.pdf`);
Â  Â  Â  Â  Â  Â  Â  Â  } catch(error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("Error creating PDF:", error);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showToast("Hubo un error al crear el PDF.");
Â  Â  Â  Â  Â  Â  Â  Â  } finally {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  btn.textContent = originalText;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  btn.disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  // --- Utility Functions ---
Â  Â  Â  Â  Â  Â  function readFileAsBase64(file) {
Â  Â  Â  Â  Â  Â  Â  Â  return new Promise((resolve, reject) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const reader = new FileReader();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  reader.onload = () => resolve(reader.result);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  reader.onerror = (error) => reject(error);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  reader.readAsDataURL(file);
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  </script>
</body>
</html>
